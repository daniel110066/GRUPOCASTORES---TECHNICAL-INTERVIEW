<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Inventario</title>
</head>
<body>
    <h1>Inventario de Productos</h1>

    <div th:if="${param.error}" style="color: red; margin-top: 10px;">
        Ya existe un producto con ese nombre.
    </div>

    <div th:if="${param.success}" style="color: green; margin-top: 10px;">
        Producto agregado con éxito.
    </div>

    <div th:if="${param.success == 'entrada'}" style="color: green; margin-top: 10px;">
        Inventario actualizado correctamente.
    </div>
    
    <div th:if="${param.error == 'cantidadInvalida'}" style="color: red; margin-top: 10px;">
        La cantidad debe ser mayor a 0.
    </div>
    
    <div th:if="${param.error == 'productoNoEncontrado'}" style="color: red; margin-top: 10px;">
        El producto seleccionado no existe.
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center;">
        <p>Bienvenido <b th:text="${usuario}"></b></p>
        <form th:action="@{/logout}" method="post" style="margin: 0;">
            <button type="submit">Cerrar sesión</button>
        </form>
    </div>

    <table border="1" cellpadding="5" cellspacing="0" style="margin-top: 20px; width: 100%;">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Descripción</th>
                <th>Cantidad</th>
                <th>Estatus</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="p : ${productos}">
                <td th:text="${p.idProducto}">1</td>
                <td th:text="${p.nombre}">Producto</td>
                <td th:text="${p.descripcion}">Descripción</td>
                <td th:text="${p.cantidad}">0</td>
                <td th:text="${p.estatus == 1 ? 'Activo' : 'Inactivo'}">Activo</td>
            </tr>
        </tbody>
    </table>

    <div style="margin-top: 30px;">
        <div th:if="${rol == 'ROLE_ADMINISTRADOR'}">
            <button type="button" onclick="mostrarModal('modalAgregar')">Agregar producto</button>
            <button type="button" onclick="mostrarModal('modalEntrada')">Aumentar inventario</button>
            <button type="submit">Dar de baja / Reactivar</button>
            <button type="submit">Ver histórico</button>
        </div>

        <div th:if="${rol == 'ROLE_ALMACENISTA'}">
            <button type="submit">Sacar inventario</button>
            <button type="submit">Ver salida de productos</button>
        </div>
    </div>

    <!-- Modal Agregar producto -->
    <div id="modalAgregar" style="
        display: flex;
        visibility: hidden;
        opacity: 0;
        transition: visibility 0s, opacity 0.3s linear;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.5);
        justify-content: center; align-items: center;">
        
        <div style="background: white; padding: 20px; border-radius: 8px; width: 300px;">
            <h3>Nuevo producto</h3>
            <form th:action="@{/productos/guardar}" method="post">
                <input type="text" name="nombre" placeholder="Nombre" required style="width: 100%; margin-bottom: 10px;" />
                <input type="text" name="descripcion" placeholder="Descripción" style="width: 100%; margin-bottom: 10px;" />
                <input type="number" name="cantidad" placeholder="Cantidad inicial" value="0" readonly style="width: 100%; margin-bottom: 10px;" />
                <div style="display: flex; justify-content: space-between;">
                    <button type="button" onclick="cerrarModal('modalAgregar')">Cancelar</button>
                    <button type="submit">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Aumentar inventario -->
    <div id="modalEntrada" style="
        display: flex;
        visibility: hidden;
        opacity: 0;
        transition: visibility 0s, opacity 0.3s linear;
        position: fixed; top: 0; left: 0;
        width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.5);
        justify-content: center; align-items: center;">
        
        <div style="background: white; padding: 20px; border-radius: 8px; width: 300px;">
            <h3>Entrada de producto</h3>
            <form th:action="@{/inventario/entrada}" method="post">
                <label for="idProducto">Producto:</label>
                <select name="idProducto" required style="width: 100%; margin-bottom: 10px;">
                    <option th:each="p : ${productos}" th:value="${p.idProducto}" th:text="${p.nombre}"></option>
                </select>
                <input type="number" name="cantidad" placeholder="Cantidad a agregar" min="1" required style="width: 100%; margin-bottom: 10px;" />
                <div style="display: flex; justify-content: space-between;">
                    <button type="button" onclick="cerrarModal('modalEntrada')">Cancelar</button>
                    <button type="submit">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Script para manejar los modales -->
    <script>
        function mostrarModal(id) {
            const modal = document.getElementById(id);
            modal.style.visibility = 'visible';
            modal.style.opacity = '1';
        }

        function cerrarModal(id) {
            const modal = document.getElementById(id);
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.visibility = 'hidden';
            }, 300);
        }
    </script>
</body>
</html>